name: CI

# –¢—Ä–∏–≥–≥–µ—Ä—ã: –Ω–∞ –ø—É—à –∏ PR –≤ –ª—é–±—ã–µ –≤–µ—Ç–∫–∏ dev –∏ main (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)
on:
  workflow_call:
    inputs:
      ref:
        description: '–ò–º—è –≤–µ—Ç–∫–∏ –∏–ª–∏ —Ç–µ–≥–∞, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—É—Å—Ç–∏–ª–∏ workflow'
        required: true
        type: string
    secrets:
      GITHUB_TOKEN:
        description: '–¢–æ–∫–µ–Ω GitHub, –ø–µ—Ä–µ–¥–∞–µ–º –∏–∑ –≤—ã–∑–≤–∞–≤—à–µ–≥–æ —Ä–µ–ø–æ'
        required: true


jobs:
  test:
    name: üß™ Run tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [python, node]  # –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º Python –∏ JS/TS

    steps:
      # 1) –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
      - name: Setup ${{ matrix.language }}
        run: |
          if [ "${{ matrix.language }}" == "python" ]; then
            python -m pip install --upgrade pip
          else
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi

      # 3) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f package.json ]; then
            npm ci
          fi

      # 4) –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      - name: Run tests
        run: |
          # –î–ª—è Python
          if command -v pytest &> /dev/null; then
            pytest --maxfail=1 --disable-warnings -q
          fi
          # –î–ª—è JavaScript/TypeScript
          if grep -q '"test":' package.json; then
            npm test
          fi
