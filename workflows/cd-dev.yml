name: CD to Dev

# –¢—Ä–∏–≥–≥–µ—Ä: —Ç–æ–ª—å–∫–æ –ø—É—à–∏ –≤ –≤–µ—Ç–∫—É dev
on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    name: üöÄ Build & Deploy to Dev
    runs-on: ubuntu-latest
    needs: test    # —Å–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏–∑ CI, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    environment: dev

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Registry
      - name: Login to Docker Registry
        run: |
          echo "${{ secrets.DOCKER_PASS }}" | docker login \
            ${{ secrets.DOCKER_REGISTRY }} \
            --username "${{ secrets.DOCKER_USER }}" \
            --password-stdin

      # 3. –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ —Å —Ç–µ–≥–æ–º dev-<SHA>
      - name: Build Docker image
        run: |
          TAG=dev-${{ github.sha }}
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/${{ github.repository }}:$TAG .

      # 4. –ü—É—à–∏–º –æ–±—Ä–∞–∑ –Ω–∞ registry
      - name: Push image
        run: |
          TAG=dev-${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/${{ github.repository }}:$TAG

      # 5. –î–µ–ø–ª–æ–π –Ω–∞ staging-—Å–µ—Ä–≤–µ—Ä –ø–æ SSH
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            cd /srv/${{ github.repository }} || exit 1
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑ –∏ –ø–æ–¥–Ω–∏–º–∞–µ–º —Å–µ—Ä–≤–∏—Å
            docker-compose -f docker-compose.dev.yml pull
            docker-compose -f docker-compose.dev.yml up -d --remove-orphans
